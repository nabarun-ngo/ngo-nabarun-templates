# .github/workflows/deploy-cloudrun.yml
name: Deploy NestJS to GCP Cloud Run

on:
  workflow_call:
    inputs:
      # Repository inputs
      tag_name:
        required: true
        type: string
        description: 'Git tag or branch to deploy'
      repo_name:
        required: true
        type: string
        description: 'Repository name'
      repo_owner_name:
        required: true
        type: string
        description: 'Repository owner'
      
      # Environment inputs
      environment_name:
        required: true
        type: string
        description: 'GitHub environment name (e.g., production, staging)'
      environment_url:
        required: false
        type: string
        description: 'Environment URL for GitHub deployments'
      
      # Cloud Run inputs
      service_name:
        required: true
        type: string
        description: 'Cloud Run service name'
      region:
        required: false
        type: string
        default: 'us-central1'
        description: 'GCP region'
      
      # Doppler inputs
      doppler_project:
        required: true
        type: string
        description: 'Doppler project name'
      doppler_config:
        required: true
        type: string
        description: 'Doppler config (e.g., prd, stg)'
      
      # Resource limits
      min_instances:
        required: false
        type: number
        default: 0
        description: 'Minimum instances (0 for free tier)'
      max_instances:
        required: false
        type: number
        default: 1
        description: 'Maximum instances'
      memory:
        required: false
        type: string
        default: '512Mi'
        description: 'Memory limit (512Mi for free tier)'
      cpu:
        required: false
        type: string
        default: '1'
        description: 'CPU limit'
      timeout:
        required: false
        type: number
        default: 300
        description: 'Request timeout in seconds'
      port:
        required: false
        type: number
        default: 3000
        description: 'Application port'
      
      # Deployment options
      enable_health_check:
        description: "Enable post-deployment health check"
        required: false
        type: boolean
        default: true
      health_check_path:
        description: "Health check endpoint path"
        required: false
        type: string
        default: '/health'
      
      # Build options
      node_version:
        description: "Node.js version to use"
        required: false
        type: string
        default: '20'
      enable_build_cache:
        description: "Enable Docker build cache"
        required: false
        type: boolean
        default: true
      
    outputs:
      # Build outputs
      build_status:
        description: 'Status of the build process'
        value: ${{ jobs.build_and_push.result }}
      image_tag:
        description: 'Docker image tag'
        value: ${{ jobs.build_and_push.outputs.image_tag }}
      
      # Deployment outputs
      deployment_status:
        description: 'Status of the deployment process'
        value: ${{ jobs.deploy_to_cloudrun.result }}
      deployment_id:
        description: 'GitHub deployment ID'
        value: ${{ jobs.deploy_to_cloudrun.outputs.deployment_id }}
      service_url:
        description: 'Cloud Run service URL'
        value: ${{ jobs.deploy_to_cloudrun.outputs.service_url }}
      
      # Summary outputs
      overall_status:
        description: 'Overall workflow execution status'
        value: ${{ (jobs.build_and_push.result == 'success' && jobs.deploy_to_cloudrun.result == 'success') && 'success' || 'failure' }}
      deployment_summary:
        description: 'Deployment summary information'
        value: 'Tag: ${{ inputs.tag_name }} | Service: ${{ inputs.service_name }} | Region: ${{ inputs.region }} | Environment: ${{ inputs.environment_name }}'
    
    secrets:
      GCP_PROJECT_ID:
        required: true
      GCP_SA_KEY:
        required: true
      DOPPLER_TOKEN:
        required: true
      REPO_TOKEN:
        required: true

jobs:
  build_and_push:
    name: 'Build and Push Docker Image'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.image_meta.outputs.tag }}
      image_name: ${{ steps.image_meta.outputs.name }}
    
    steps:
      - name: Checkout repository | Tag ${{ inputs.tag_name }}
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag_name }}
          repository: '${{ inputs.repo_owner_name }}/${{ inputs.repo_name }}'
          fetch-depth: 0
          token: ${{ secrets.REPO_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.REPO_TOKEN }}

      - name: Generate image metadata
        id: image_meta
        run: |
          REPO_LOWER=$(echo "${{ inputs.repo_owner_name }}/${{ inputs.repo_name }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME="ghcr.io/${REPO_LOWER}"
          IMAGE_TAG="${{ inputs.tag_name }}"
          
          echo "name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full=${IMAGE_NAME}:${IMAGE_TAG}" >> $GITHUB_OUTPUT
          
          echo "üì¶ Image: ${IMAGE_NAME}:${IMAGE_TAG}"

      - name: Set up Docker Buildx (if cache enabled)
        if: inputs.enable_build_cache
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        run: |
          IMAGE_NAME="${{ steps.image_meta.outputs.name }}"
          IMAGE_TAG="${{ steps.image_meta.outputs.tag }}"
          
          echo "üî® Building Docker image..."
          docker build \
            --tag ${IMAGE_NAME}:${IMAGE_TAG} \
            --tag ${IMAGE_NAME}:latest \
            --label "org.opencontainers.image.source=https://github.com/${{ inputs.repo_owner_name }}/${{ inputs.repo_name }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "org.opencontainers.image.version=${{ inputs.tag_name }}" \
            .
          
          echo "üì¶ Pushing to GitHub Container Registry..."
          docker push ${IMAGE_NAME}:${IMAGE_TAG}
          docker push ${IMAGE_NAME}:latest
          
          echo "‚úÖ Image pushed successfully"

      - name: Image size and security scan
        run: |
          IMAGE_NAME="${{ steps.image_meta.outputs.name }}"
          IMAGE_TAG="${{ steps.image_meta.outputs.tag }}"
          
          echo "üìä Image Size:"
          docker images ${IMAGE_NAME}:${IMAGE_TAG} --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
          
          echo ""
          echo "üîç Image Layers:"
          docker history ${IMAGE_NAME}:${IMAGE_TAG} --human=true --no-trunc=false | head -10

  deploy_to_cloudrun:
    name: 'Deploy to Cloud Run'
    runs-on: ubuntu-latest
    needs: [build_and_push]
    if: |
      always() &&
      needs.build_and_push.result == 'success'
    environment: 
      name: ${{ inputs.environment_name }}
      url: ${{ inputs.environment_url }}
    outputs:
      deployment_id: ${{ steps.deployment.outputs.deployment_id }}
      service_url: ${{ steps.get_url.outputs.url }}
    
    steps:
      - name: Create GitHub Deployment
        uses: chrnorm/deployment-action@v2
        id: deployment
        with:
          token: ${{ secrets.REPO_TOKEN }}
          environment-url: ${{ inputs.environment_url }}
          environment: ${{ inputs.environment_name }}
          repo: ${{ inputs.repo_name }}
          owner: ${{ inputs.repo_owner_name }}
          ref: ${{ inputs.tag_name }}
          description: 'Deploying ${{ inputs.tag_name }} to Cloud Run'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          IMAGE_NAME="${{ needs.build_and_push.outputs.image_name }}"
          IMAGE_TAG="${{ needs.build_and_push.outputs.image_tag }}"
          
          echo "üöÄ Deploying ${IMAGE_NAME}:${IMAGE_TAG} to Cloud Run..."
          
          gcloud run deploy ${{ inputs.service_name }} \
            --image=${IMAGE_NAME}:${IMAGE_TAG} \
            --platform=managed \
            --region=${{ inputs.region }} \
            --allow-unauthenticated \
            --min-instances=${{ inputs.min_instances }} \
            --max-instances=${{ inputs.max_instances }} \
            --memory=${{ inputs.memory }} \
            --cpu=${{ inputs.cpu }} \
            --timeout=${{ inputs.timeout }} \
            --port=${{ inputs.port }} \
            --set-env-vars="DOPPLER_TOKEN=${{ secrets.DOPPLER_TOKEN }},DOPPLER_PROJECT=${{ inputs.doppler_project }},DOPPLER_CONFIG=${{ inputs.doppler_config }},VERSION=${{ inputs.tag_name }},ENVIRONMENT=${{ inputs.environment_name }}" \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --quiet

      - name: Get service URL
        id: get_url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ inputs.service_name }} \
            --region=${{ inputs.region }} \
            --format='value(status.url)' \
            --project=${{ secrets.GCP_PROJECT_ID }})
          
          echo "url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "‚úÖ Service deployed to: ${SERVICE_URL}"

      - name: Wait for service to be ready
        run: |
          echo "‚è≥ Waiting for service to be ready..."
          sleep 30

      - name: Health check deployment
        if: inputs.enable_health_check
        id: health_check
        run: |
          SERVICE_URL="${{ steps.get_url.outputs.url }}"
          HEALTH_URL="${SERVICE_URL}${{ inputs.health_check_path }}"
          MAX_RETRIES=10
          RETRY_DELAY=10
          
          echo "üè• Checking health endpoint: ${HEALTH_URL}"
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${HEALTH_URL} || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Health check passed (HTTP $HTTP_CODE)"
              exit 0
            else
              echo "‚ö†Ô∏è  Health check failed (HTTP $HTTP_CODE)"
              if [ $i -lt $MAX_RETRIES ]; then
                echo "Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
              fi
            fi
          done
          
          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Get deployment details
        if: always()
        run: |
          echo "üìã Deployment Details:"
          gcloud run services describe ${{ inputs.service_name }} \
            --region=${{ inputs.region }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --format='table(
              metadata.name,
              status.url,
              status.latestReadyRevisionName,
              spec.template.spec.containers[0].image,
              metadata.labels
            )'

      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          state: 'success'
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          token: ${{ secrets.REPO_TOKEN }}
          environment-url: ${{ steps.get_url.outputs.url }}
          repo: ${{ inputs.repo_name }}
          owner: ${{ inputs.repo_owner_name }}

      - name: Update deployment status (failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          state: 'failure'
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          token: ${{ secrets.REPO_TOKEN }}
          environment-url: ${{ inputs.environment_url }}
          repo: ${{ inputs.repo_name }}
          owner: ${{ inputs.repo_owner_name }}

  restart_service:
    name: 'Restart Service (Manual Only)'
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'restart'
    environment: ${{ inputs.environment_name }}
    timeout-minutes: 10
    
    steps:
      - name: Create GitHub Deployment
        uses: chrnorm/deployment-action@v2
        id: deployment
        with:
          token: ${{ secrets.REPO_TOKEN }}
          environment-url: ${{ inputs.environment_url }}
          environment: ${{ inputs.environment_name }}
          repo: ${{ inputs.repo_name }}
          owner: ${{ inputs.repo_owner_name }}
          ref: ${{ inputs.tag_name }}
          description: 'Restarting service to fetch fresh secrets'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Restart service (force new deployment)
        run: |
          echo "üîÑ Restarting service..."
          
          # Force a new revision by updating a label with timestamp
          TIMESTAMP=$(date +%s)
          
          gcloud run services update ${{ inputs.service_name }} \
            --region=${{ inputs.region }} \
            --update-labels=restart-timestamp=${TIMESTAMP} \
            --update-env-vars="DOPPLER_TOKEN=${{ secrets.DOPPLER_TOKEN }},DOPPLER_PROJECT=${{ inputs.doppler_project }},DOPPLER_CONFIG=${{ inputs.doppler_config }},VERSION=${{ inputs.tag_name }}" \
            --project=${{ secrets.GCP_PROJECT_ID }}
          
          echo "‚úÖ Service restarted successfully!"
          echo "üîê New containers will fetch fresh secrets from Doppler on startup"

      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          state: 'success'
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          token: ${{ secrets.REPO_TOKEN }}
          environment-url: ${{ inputs.environment_url }}
          repo: ${{ inputs.repo_name }}
          owner: ${{ inputs.repo_owner_name }}

      - name: Update deployment status (failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          state: 'failure'
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          token: ${{ secrets.REPO_TOKEN }}
          environment-url: ${{ inputs.environment_url }}
          repo: ${{ inputs.repo_name }}
          owner: ${{ inputs.repo_owner_name }}
