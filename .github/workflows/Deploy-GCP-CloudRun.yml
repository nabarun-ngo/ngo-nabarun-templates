name: Deploy NestJS to GCP Cloud Run

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: 'Cloud Run service name'
      environment:
        required: true
        type: string
        description: 'Target Environment' 
      region:
        required: false
        type: string
        default: 'us-central1'
        description: 'GCP region'
      doppler-project:
        required: true
        type: string
        description: 'Doppler project name'
      doppler-config:
        required: true
        type: string
        description: 'Doppler config (e.g., prd, stg)'
      min-instances:
        required: false
        type: number
        default: 0
        description: 'Minimum instances (0 for free tier)'
      max-instances:
        required: false
        type: number
        default: 1
        description: 'Maximum instances'
      memory:
        required: false
        type: string
        default: '512Mi'
        description: 'Memory limit (512Mi for free tier)'
      cpu:
        required: false
        type: string
        default: '1'
        description: 'CPU limit'
      timeout:
        required: false
        type: number
        default: 300
        description: 'Request timeout in seconds'
      port:
        required: false
        type: number
        default: 3000
        description: 'Application port'
    secrets:
      GCP_PROJECT_ID:
        required: true
      GCP_SA_KEY:
        required: true
      DOPPLER_TOKEN:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.action == 'deploy'
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Convert repository name to lowercase
        id: repo
        run: echo "name=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        run: |
          IMAGE_NAME=ghcr.io/${{ steps.repo.outputs.name }}
          
          echo "üî® Building Docker image..."
          docker build -t ${IMAGE_NAME}:${{ github.sha }} -t ${IMAGE_NAME}:latest .
          
          echo "üì¶ Pushing to GitHub Container Registry..."
          docker push ${IMAGE_NAME}:${{ github.sha }}
          docker push ${IMAGE_NAME}:latest
          
          echo "‚úÖ Image pushed successfully"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run with Doppler integration
        run: |
          gcloud run deploy ${{ inputs.service-name }} \
            --image=ghcr.io/${{ steps.repo.outputs.name }}:${{ github.sha }} \
            --platform=managed \
            --region=${{ inputs.region }} \
            --allow-unauthenticated \
            --min-instances=${{ inputs.min-instances }} \
            --max-instances=${{ inputs.max-instances }} \
            --memory=${{ inputs.memory }} \
            --cpu=${{ inputs.cpu }} \
            --timeout=${{ inputs.timeout }} \
            --port=${{ inputs.port }} \
            --set-env-vars="DOPPLER_TOKEN=${{ secrets.DOPPLER_TOKEN }},DOPPLER_PROJECT=${{ inputs.doppler-project }},DOPPLER_CONFIG=${{ inputs.doppler-config }}" \
            --project=${{ secrets.GCP_PROJECT_ID }}

      - name: Get service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ inputs.service-name }} \
            --region=${{ inputs.region }} \
            --format='value(status.url)' \
            --project=${{ secrets.GCP_PROJECT_ID }})
          echo "‚úÖ Service deployed to: $SERVICE_URL"

  restart:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'restart'
    environment: ${{ inputs.environment }}
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Restart service (force new deployment)
        run: |
          echo "üîÑ Restarting service..."
          
          # Force a new revision by updating a label with timestamp
          TIMESTAMP=$(date +%s)
          
          gcloud run services update ${{ inputs.service-name }} \
            --region=${{ inputs.region }} \
            --update-labels=restart-timestamp=${TIMESTAMP} \
            --update-env-vars="DOPPLER_TOKEN=${{ secrets.DOPPLER_TOKEN }},DOPPLER_PROJECT=${{ inputs.doppler-project }},DOPPLER_CONFIG=${{ inputs.doppler-config }}" \
            --project=${{ secrets.GCP_PROJECT_ID }}
          
          echo "‚úÖ Service restarted successfully!"
          echo "üîê New containers will fetch fresh secrets from Doppler on startup"

