name: "MongoDB Cloud Tasks"

on:
  workflow_call:
    inputs:
      target-env:
        description: 'Target Environment'  
        required: true
        type: string
      script-path:
        description: "Relative path to the MongoDB script (.js)"
        required: false
        type: string
      import-file:
        description: "Path to JSON file to import"
        required: false
        type: string
      import-collection:
        description: "Target collection for import"
        required: false
        type: string
      
    secrets:
      mongo-uri:
        description: "MongoDB Atlas connection string"
        required: true

jobs:
  run-mongo-script:
    if: ${{ inputs.script-path != '' }}
    runs-on: ubuntu-latest
    name: Run Mongo Script
    environment: ${{ inputs.target-env }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Mongo Shell
        run: |
          curl -fsSL https://pgp.mongodb.com/server-6.0.asc | sudo gpg -o /usr/share/keyrings/mongodb-server-6.0.gpg --dearmor
          echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-mongosh

      - name: Check if script exists
        id: check_script
        run: |
          if [ ! -f "${{ inputs.script-path }}" ]; then
            echo "Script not found: ${{ inputs.script-path }}. Skipping execution."
            echo "exists=false" >> $GITHUB_OUTPUT
          else
            echo "exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Run MongoDB script on Atlas
        if: steps.check_script.outputs.exists == 'true'
        run: |
          mongosh "${{ secrets.mongo-uri }}" "${{ inputs.script-path }}"

  import-mongo-data:
    if: ${{ inputs.import-file != '' && inputs.import-collection != '' }}
    runs-on: ubuntu-latest
    name: Import Mongo Data
    environment: ${{ inputs.target-env }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Mongo Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y mongo-tools

      - name: Check if import file exists
        id: check_import
        run: |
          if [ ! -f "${{ inputs.import-file }}" ]; then
            echo "Import file not found: ${{ inputs.import-file }}. Skipping execution."
            echo "exists=false" >> $GITHUB_OUTPUT
          else
            echo "exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Import data into Atlas
        if: steps.check_import.outputs.exists == 'true'
        run: |
          mongoimport --uri="${{ secrets.mongo-uri }}" \
                      --collection="${{ inputs.import-collection }}" \
                      --file="${{ inputs.import-file }}" \
                      --jsonArray
