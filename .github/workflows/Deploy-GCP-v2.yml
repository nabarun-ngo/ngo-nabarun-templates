name: Build and Deploy to GCP App Engine v2
on:
  workflow_call:
    inputs:
      tag_name:
        required: true
        type: string
      repo_name:
        required: true
        type: string
      repo_owner_name:
        required: true
        type: string
      environment_name:
        required: true
        type: string
      environment_url:
        required: false
        type: string
      target_folder:
        required: true
        type: string
      gae_app_yaml_path:
        required: false
        type: string
        default: 'app.yaml'
      gae_service_name:
        required: false
        type: string
        default: 'default'
      app_env:
        required: true
        type: string
      app_doppler_project_name:
        required: true
        type: string
      app_log_level:
        required: false
        type: string
        default: 'INFO'
      keep_gae_versions:
        description: "Number of GAE versions to keep (optional, default 1)"
        required: false
        type: string
        default: 1
      gcs_keep_days:
        description: "Number of days to keep files in GCS bucket (optional, default 5)"
        required: false
        type: string
        default: 5
      # Application type configuration
      application_type:
        description: "Application type: 'java' or 'nodejs'"
        required: true
        type: string
      # Java-specific inputs
      java_version:
        description: "Java version to use (default: 17)"
        required: false
        type: string
        default: '17'
      maven_options:
        description: "Additional Maven options"
        required: false
        type: string
        default: '-Dmaven.test.skip=true -Dmaven.javadoc.skip=true'
      # Node.js-specific inputs
      node_version:
        description: "Node.js version to use (default: 20)"
        required: false
        type: string
        default: '20'
      npm_command:
        description: "NPM build command (default: 'npm run build')"
        required: false
        type: string
        default: 'npm run build'
      install_command:
        description: "NPM install command (default: 'npm ci')"
        required: false
        type: string
        default: 'npm ci'
      use_doppler_cli:
        description: "Install Doppler CLI in the container for runtime secrets (default: false, uses env vars)"
        required: false
        type: boolean
        default: false
      start_command:
        description: "Start command for Node.js app in app.yaml (default: 'npm start')"
        required: false
        type: string
        default: 'npm start'
      run_db_migration:
        description: "Run database migration before deployment (default: false)"
        required: false
        type: boolean
        default: false
      migration_script:
        description: "Path to migration script relative to repository root (default: 'migrate.sh')"
        required: false
        type: string
        default: 'migrate.sh'
      entrypoint_script:
        description: "Path to entrypoint script relative to repository root (default: 'start.sh')"
        required: false
        type: string
        default: 'start.sh'
      # Common deployment inputs
      deployment_timeout:
        description: "Deployment timeout in minutes (default: 25)"
        required: false
        type: number
        default: 25
      enable_health_check:
        description: "Enable post-deployment health check (default: true)"
        required: false
        type: boolean
        default: true
    outputs:
      # Build outputs
      build_status:
        description: 'Status of the build process'
        value: ${{ inputs.application_type == 'java' && jobs.build_java_application.result || jobs.build_nodejs_application.result }}
      artifact_name:
        description: 'Name of the built artifact'
        value: ${{ inputs.application_type == 'java' && jobs.build_java_application.outputs.artifact_name || jobs.build_nodejs_application.outputs.artifact_name }}
      # Deployment outputs
      deployment_status:
        description: 'Status of the deployment process'
        value: ${{ jobs.deploy_to_gcp.result }}
      deployment_version:
        description: 'Deployed GAE version ID'
        value: ${{ jobs.deploy_to_gcp.outputs.deployment_version }}
      deployment_id:
        description: 'GitHub deployment ID'
        value: ${{ jobs.deploy_to_gcp.outputs.deployment_id }}
      # Cleanup outputs
      cleanup_status:
        description: 'Status of the cleanup process'
        value: ${{ jobs.clean_gcp_resources.result }}
      # Summary outputs
      overall_status:
        description: 'Overall workflow execution status'
        value: ${{ (inputs.application_type == 'java' && jobs.build_java_application.result == 'success' || inputs.application_type == 'nodejs' && jobs.build_nodejs_application.result == 'success') && jobs.deploy_to_gcp.result == 'success' && 'success' || 'failure' }}
      deployment_summary:
        description: 'Deployment summary information'
        value: 'Tag: ${{ inputs.tag_name }} | Service: ${{ inputs.gae_service_name }} | Environment: ${{ inputs.environment_name }} | Version: ${{ jobs.deploy_to_gcp.outputs.deployment_version }}'
    secrets:
      gcp_project_id:
        required: true
      gcp_service_account:
        required: true
      app_doppler_service_token:
        required: true
      repo_token:
        required: true


jobs:

  build_java_application:
    name: 'Build Java Application'
    runs-on: ubuntu-latest
    if: inputs.application_type == 'java'
    timeout-minutes: 20
    outputs:
      artifact_name: ${{ steps.get-jar-path.outputs.file_name }}
    steps:
      - name: Checkout repository | Tag ${{ inputs.tag_name }}
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag_name }}
          repository: '${{ inputs.repo_owner_name }}/${{ inputs.repo_name }}'
          fetch-depth: 0
          token: ${{ secrets.repo_token }}
    
      - name: Build Java Application with Maven
        id: maven_build
        uses: nabarun-ngo/ngo-nabarun-templates/.github/actions/build-java@main
        with:
          java_version: ${{ inputs.java_version }}
          maven_command: 'clean package'
          maven_options: ${{ inputs.maven_options }}
          upload_test_results: 'false'
          enable_cache: 'true'
          cache_key_prefix: 'maven'
          
      - name: Validate and Get JAR file path
        id: get-jar-path
        uses: nabarun-ngo/ngo-nabarun-templates/.github/actions/validate-and-find-file@main
        with:
          search_directory: ${{ inputs.target_folder }}
          file_pattern: '*.jar'
          exclude_patterns: 'sources,javadoc,test'
          file_type: 'JAR'
          selection_strategy: 'first'
          validate_file: 'true'
          
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar-${{ inputs.tag_name }}
          path: ${{ steps.get-jar-path.outputs.file_path }}
          retention-days: 1
          
      - name: Upload app.yaml artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-yaml-${{ inputs.tag_name }}
          path: ${{ inputs.gae_app_yaml_path }}
          retention-days: 1

  build_nodejs_application:
    name: 'Build Node.js Application'
    runs-on: ubuntu-latest
    if: inputs.application_type == 'nodejs'
    timeout-minutes: 20
    outputs:
      artifact_name: deployment-package
    steps:
      - name: Checkout repository | Tag ${{ inputs.tag_name }}
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag_name }}
          repository: '${{ inputs.repo_owner_name }}/${{ inputs.repo_name }}'
          fetch-depth: 0
          token: ${{ secrets.repo_token }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'
          
      - name: Install all dependencies (including dev)
        run: ${{ inputs.install_command }}
        
      - name: Build Node.js application
        run: ${{ inputs.npm_command }}
        
      - name: Install production dependencies only
        run: |
          # Remove node_modules to ensure clean production dependencies
          rm -rf node_modules
          # Install only production dependencies
          npm ci --omit=dev --ignore-scripts
        
      - name: Install Doppler CLI (if enabled)
        if: inputs.use_doppler_cli
        run: |
          # Install Doppler CLI for runtime secret management
          curl -Ls --tlsv1.2 --proto "=https" --retry 3 https://cli.doppler.com/install.sh | sh
          
      - name: Create deployment package
        run: |
          mkdir -p deployment-package
          
          # Copy built application (try common output directories)
          if [ -d "dist" ]; then
            echo "Copying dist directory..."
            cp -r dist deployment-package/
          elif [ -d "build" ]; then
            echo "Copying build directory..."
            cp -r build deployment-package/
          else
            echo "Warning: No dist or build directory found"
          fi
          
          # Copy production node_modules (without dev dependencies)
          echo "Copying production node_modules..."
          cp -r node_modules deployment-package/
          
          # Copy Doppler CLI binary if installed
          if [ "${{ inputs.use_doppler_cli }}" == "true" ]; then
            echo "Copying Doppler CLI..."
            mkdir -p deployment-package/bin
            cp $(which doppler) deployment-package/bin/
            chmod +x deployment-package/bin/doppler
            echo "âœ“ Doppler CLI included in deployment package"
          fi
          
          # Copy scripts if using Doppler CLI
          if [ "${{ inputs.use_doppler_cli }}" == "true" ]; then
            # Copy entrypoint script
            if [ -f "${{ inputs.entrypoint_script }}" ]; then
              echo "Copying entrypoint script: ${{ inputs.entrypoint_script }}..."
              cp "${{ inputs.entrypoint_script }}" deployment-package/
              chmod +x "deployment-package/$(basename ${{ inputs.entrypoint_script }})"
              echo "âœ“ Entrypoint script included"
            else
              echo "âš ï¸  Warning: Entrypoint script not found: ${{ inputs.entrypoint_script }}"
            fi
            
            # Copy migration script if migrations are enabled
            if [ "${{ inputs.run_db_migration }}" == "true" ] && [ -f "${{ inputs.migration_script }}" ]; then
              echo "Copying migration script: ${{ inputs.migration_script }}..."
              cp "${{ inputs.migration_script }}" deployment-package/
              chmod +x "deployment-package/$(basename ${{ inputs.migration_script }})"
              echo "âœ“ Migration script included"
            fi
          fi
          
          # Copy package files
          echo "Copying package files..."
          cp package.json deployment-package/
          cp package-lock.json deployment-package/ 2>/dev/null || true
          
          # Copy Prisma schema if exists (needed for migrations)
          if [ -d "prisma" ]; then
            echo "Copying Prisma schema..."
            cp -r prisma deployment-package/
            echo "âœ“ Prisma schema included"
          fi
          
          # Copy any other necessary files
          [ -f .env.example ] && cp .env.example deployment-package/ || true
          [ -f ecosystem.config.js ] && cp ecosystem.config.js deployment-package/ || true
          
          # Display package size
          echo "Deployment package size:"
          du -sh deployment-package/
          
          # Display node_modules size (should be smaller without dev deps)
          echo "Production node_modules size:"
          du -sh deployment-package/node_modules/
          
      - name: Verify no dev dependencies in package
        run: |
          cd deployment-package
          # Check if any common dev dependencies are present
          if [ -d "node_modules" ]; then
            DEV_DEPS=$(find node_modules -maxdepth 1 -type d \( \
              -name "*jest*" -o \
              -name "*eslint*" -o \
              -name "*prettier*" -o \
              -name "*typescript" -o \
              -name "*webpack*" -o \
              -name "*babel*" -o \
              -name "*@types*" \
            \) | wc -l)
            
            if [ "$DEV_DEPS" -gt 0 ]; then
              echo "Warning: Found $DEV_DEPS potential dev dependencies"
              echo "Listing potential dev dependencies:"
              find node_modules -maxdepth 1 -type d \( \
                -name "*jest*" -o \
                -name "*eslint*" -o \
                -name "*prettier*" -o \
                -name "*typescript" -o \
                -name "*webpack*" -o \
                -name "*babel*" -o \
                -name "*@types*" \
              \)
            else
              echo "âœ“ No obvious dev dependencies found in production package"
            fi
          fi
          
      - name: Upload Node.js artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-nodejs-${{ inputs.tag_name }}
          path: deployment-package/
          retention-days: 1
          
      - name: Upload app.yaml artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-yaml-${{ inputs.tag_name }}
          path: ${{ inputs.gae_app_yaml_path }}
          retention-days: 1

  deploy_to_gcp:
    name: 'Deploy to GCP App Engine'
    runs-on: ubuntu-latest
    needs: [build_java_application, build_nodejs_application]
    if: |
      always() &&
      (needs.build_java_application.result == 'success' || needs.build_nodejs_application.result == 'success')
    environment: ${{ inputs.environment_name }}
    outputs:
      deployment_version: ${{ steps.get_version.outputs.version }}
      deployment_id: ${{ steps.deployment.outputs.deployment_id }}
    steps:
      # Download Java artifact
      - name: Download JAR artifact
        if: inputs.application_type == 'java'
        uses: actions/download-artifact@v4
        with:
          name: application-jar-${{ inputs.tag_name }}
          path: ./artifacts/
      
      # Download Node.js artifact
      - name: Download Node.js artifact
        if: inputs.application_type == 'nodejs'
        uses: actions/download-artifact@v4
        with:
          name: application-nodejs-${{ inputs.tag_name }}
          path: ./artifacts/
          
      - name: Download app.yaml artifact to workspace root
        uses: actions/download-artifact@v4
        with:
          name: app-yaml-${{ inputs.tag_name }}
          path: .

      - name: Create GitHub Deployment
        uses: chrnorm/deployment-action@v2
        id: deployment
        with:
          token: ${{ secrets.repo_token }}
          environment-url: ${{ inputs.environment_url }}
          environment: ${{ inputs.environment_name }}
          repo: ${{ inputs.repo_name }}
          owner: ${{ inputs.repo_owner_name }}
          ref: ${{ inputs.tag_name }}
                  
      - name: Setup Google Cloud CLI
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ secrets.gcp_project_id }}
          credentials_json: ${{ secrets.gcp_service_account }}
        
      - name: Setup Application Variables
        uses: ikuanyshbekov/app-yaml-env-compiler@v1.0
        with:
          path: '${{ inputs.gae_app_yaml_path }}'
        env:
          ENVIRONMENT: ${{ inputs.app_env }}
          DOPPLER_PROJECT_NAME: ${{ inputs.app_doppler_project_name }}
          DOPPLER_SERVICE_TOKEN: ${{ secrets.app_doppler_service_token }}
          LOG_LEVEL: ${{ inputs.app_log_level }}
          VERSION: ${{ inputs.tag_name }}
      
      - name: Run Database Migration (Node.js)
        if: inputs.application_type == 'nodejs' && inputs.run_db_migration && inputs.use_doppler_cli
        working-directory: ./artifacts
        run: |
          echo "ðŸ”„ Running database migration..."
          
          # Set Doppler environment variables
          export DOPPLER_TOKEN="${{ secrets.app_doppler_service_token }}"
          export DOPPLER_PROJECT="${{ inputs.app_doppler_project_name }}"
          export DOPPLER_CONFIG="${{ inputs.app_env }}"
          
          # Make migration script executable
          chmod +x "$(basename ${{ inputs.migration_script }})"
          
          # Run migration script
          ./$(basename ${{ inputs.migration_script }})
          
          echo "âœ… Database migration completed successfully"
         
      - name: Deploy to Google App Engine (Java)
        if: inputs.application_type == 'java'
        uses: google-github-actions/deploy-appengine@v2
        timeout-minutes: 20
        with:
          project_id: ${{ secrets.gcp_project_id }}
          deliverables: './artifacts/${{ needs.build_java_application.outputs.artifact_name }}'
          flags: '--appyaml=${{ inputs.gae_app_yaml_path }} --quiet --no-promote'

      - name: Deploy to Google App Engine (Node.js)
        if: inputs.application_type == 'nodejs'
        uses: google-github-actions/deploy-appengine@v2
        timeout-minutes: 20
        with:
          project_id: ${{ secrets.gcp_project_id }}
          deliverables: '${{ inputs.gae_app_yaml_path }}'
          working_directory: './artifacts'
          flags: '--quiet --no-promote'
          
      - name: Get deployed version
        id: get_version
        uses: nabarun-ngo/ngo-nabarun-templates/.github/actions/gcp-get-deployed-version@main
        with:
          project_id: ${{ secrets.gcp_project_id }}
          service_name: ${{ inputs.gae_service_name }}
          
      - name: Promote to production
        uses: nabarun-ngo/ngo-nabarun-templates/.github/actions/gcp-promote-gae-traffic@main
        timeout-minutes: 10
        with:
          project_id: ${{ secrets.gcp_project_id }}
          service_name: ${{ inputs.gae_service_name }}
          version: ${{ steps.get_version.outputs.version }}

      - name: Health check deployment
        if: inputs.enable_health_check
        uses: nabarun-ngo/ngo-nabarun-templates/.github/actions/gcp-health-check-deployment@main
        timeout-minutes: 5
        with:
          environment_url: ${{ inputs.environment_url }}

      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          state: 'success'
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          token: ${{ secrets.repo_token }}
          environment-url: ${{ inputs.environment_url }}
          repo: ${{ inputs.repo_name }}
          owner: ${{ inputs.repo_owner_name }}

      - name: Update deployment status (failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          state: 'failure'
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          token: ${{ secrets.repo_token }}
          environment-url: ${{ inputs.environment_url }}
          repo: ${{ inputs.repo_name }}
          owner: ${{ inputs.repo_owner_name }}

  clean_gcp_resources:
    name: 'Clean Up Old GCP Resources'
    runs-on: ubuntu-latest
    needs: [deploy_to_gcp]
    environment: ${{ inputs.environment_name }}
    # Only run cleanup when deployment succeeds
    if: needs.deploy_to_gcp.result == 'success'
    timeout-minutes: 20
    steps:
      - name: Setup Google Cloud CLI
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ secrets.gcp_project_id }}
          credentials_json: ${{ secrets.gcp_service_account }}

      - name: Clean Artifact Registry repositories
        uses: nabarun-ngo/ngo-nabarun-templates/.github/actions/gcp-clean-artifact-registry@main
        continue-on-error: true
        with:
          project_id: ${{ secrets.gcp_project_id }}

      - name: Clean old GAE versions
        uses: nabarun-ngo/ngo-nabarun-templates/.github/actions/gcp-clean-gae-versions@main
        with:
          project_id: ${{ secrets.gcp_project_id }}
          service_name: ${{ inputs.gae_service_name }}
          keep_versions: ${{ inputs.keep_gae_versions }}

      - name: Clean old GCS files
        uses: nabarun-ngo/ngo-nabarun-templates/.github/actions/gcp-clean-gcs-files@main
        continue-on-error: true
        with:
          project_id: ${{ secrets.gcp_project_id }}
          keep_days: ${{ inputs.gcs_keep_days }}
          bucket_patterns: 'auto'
          timeout_minutes: '10'
