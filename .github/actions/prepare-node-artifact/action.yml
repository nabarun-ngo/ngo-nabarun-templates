name: 'Prepare Node.js Artifact'
description: 'Prepares a production-ready Node.js artifact with optimized dependencies and tools'

inputs:
  artifact_pattern:
    description: 'Pattern to match build artifacts (e.g., dist, build)'
    required: false
    default: ''
  package_manager:
    description: 'Package manager to use (npm, yarn, pnpm)'
    required: false
    default: 'npm'
  include_node_modules:
    description: 'Include node_modules in artifact'
    required: false
    default: 'true'
  install_doppler_cli:
    description: 'Install Doppler CLI'
    required: false
    default: 'true'
  doppler_cli_version:
    description: 'Doppler CLI version'
    required: false
    default: 'latest'
  include_prisma_schema:
    description: 'Include Prisma schema for migrations'
    required: false
    default: 'true'

outputs:
  artifact_path:
    description: 'Path to the prepared artifact'
    value: ${{ steps.set-path.outputs.path }}

runs:
  using: "composite"
  steps:
    - name: Prepare production deployment artifact
      shell: bash
      run: |
        echo "ðŸ“¦ Preparing production-only deployment artifact..."
        
        # Create deployment directory
        mkdir -p deployment-artifact
        
        # Copy build output
        PATTERN="${{ inputs.artifact_pattern }}"
        if [ -z "$PATTERN" ]; then
          if [ -d "dist" ]; then
            PATTERN="dist"
          elif [ -d "build" ]; then
            PATTERN="build"
          else
            echo "âŒ No build output found"
            exit 1
          fi
        fi
        
        echo "ðŸ“ Copying build output from: $PATTERN"
        cp -r $PATTERN deployment-artifact/
        
        # Copy package files
        echo "ðŸ“„ Copying package files..."
        cp package.json deployment-artifact/
        [ -f package-lock.json ] && cp package-lock.json deployment-artifact/ || true
        [ -f yarn.lock ] && cp yarn.lock deployment-artifact/ || true
        [ -f pnpm-lock.yaml ] && cp pnpm-lock.yaml deployment-artifact/ || true
        
        # Copy Prisma schema if it exists (needed for migrations)
        if [ "${{ inputs.include_prisma_schema }}" == "true" ] && [ -d "prisma" ]; then
          echo "ðŸ“‹ Copying Prisma schema..."
          mkdir -p deployment-artifact/prisma
          cp -r prisma/* deployment-artifact/prisma/
          echo "âœ… Prisma schema copied"
        fi

         # Copy .gcloudignore if it exists
        if [ -f ".gcloudignore" ]; then
          echo "ðŸ“ Copying .gcloudignore..."
          cp .gcloudignore deployment-artifact/
        fi
        
        # Copy .env files if they exist (for local testing)
        if [ -f ".env" ]; then
          echo "ðŸ“ Copying .env file..."
          cp .env deployment-artifact/ || true
        fi
        if [ -f ".env.production" ]; then
          echo "ðŸ“ Copying .env.production file..."
          cp .env.production deployment-artifact/ || true
        fi
        
        # Install production dependencies only
        if [ "${{ inputs.include_node_modules }}" == "true" ]; then
          echo "ðŸ“¦ Installing production dependencies only..."
          cd deployment-artifact
          
          case "${{ inputs.package_manager }}" in
            npm)
              npm ci --omit=dev --ignore-scripts
              ;;
            yarn)
              yarn install --production --frozen-lockfile --ignore-scripts
              ;;
            pnpm)
              pnpm install --prod --frozen-lockfile --ignore-scripts
              ;;
          esac
          
          # Ensure Prisma client is generated if Prisma is present
          if [ -d "prisma" ] && [ -d "node_modules" ]; then
            echo "ðŸ”„ Ensuring Prisma client is generated..."
            if command -v npx &> /dev/null; then
              npx prisma generate 2>/dev/null || echo "âš ï¸ Prisma generate skipped (might not be needed)"
            fi
          fi
          
          cd ..
          
          # Show size comparison
          echo "ðŸ“Š Size comparison:"
          echo "Full node_modules: $(du -sh node_modules 2>/dev/null | cut -f1 || echo 'N/A')"
          echo "Production node_modules: $(du -sh deployment-artifact/node_modules 2>/dev/null | cut -f1 || echo 'N/A')"
        fi

    - name: Install Doppler CLI in artifact
      if: inputs.install_doppler_cli == 'true'
      shell: bash
      run: |
        echo "ðŸ” Installing Doppler CLI..."
        cd deployment-artifact
        
        # Create bin directory
        mkdir -p bin
        
        # Download and install Doppler CLI
        if [ "${{ inputs.doppler_cli_version }}" == "latest" ]; then
          echo "Downloading latest Doppler CLI..."
          curl -Ls --tlsv1.2 --proto "=https" --retry 3 https://cli.doppler.com/install.sh | sh -s -- --no-install --no-package-manager
        else
          echo "Downloading Doppler CLI version ${{ inputs.doppler_cli_version }}..."
          curl -Ls --tlsv1.2 --proto "=https" --retry 3 https://cli.doppler.com/install.sh | sh -s -- --no-install --no-package-manager --version ${{ inputs.doppler_cli_version }}
        fi
        
        # Move doppler binary to bin directory
        mv doppler bin/
        chmod +x bin/doppler
        
        # Verify installation
        ./bin/doppler --version
        
        echo "âœ… Doppler CLI installed successfully"
        cd ..

    - name: Verify artifact contents
      shell: bash
      run: |
        echo "ðŸ“‹ Verifying artifact contents..."
        cd deployment-artifact
        
        echo "âœ… Contents of deployment-artifact:"
        ls -la
        
        if [ -d "prisma" ]; then
          echo "âœ… Prisma directory present:"
          ls -la prisma/
        fi
        
        if [ -d "node_modules" ]; then
          echo "âœ… node_modules present (size: $(du -sh node_modules | cut -f1))"
        fi
        
        if [ -d "bin" ] && [ -f "bin/doppler" ]; then
          echo "âœ… Doppler CLI present:"
          ./bin/doppler --version
        fi
        
        cd ..

    - name: Set output path
      id: set-path
      shell: bash
      run: echo "path=deployment-artifact" >> $GITHUB_OUTPUT
